{% extends "base.html" %}
    {% block head %}
        <title>GISSMO - {{ name }}</title>
        <!-- Plotly.js -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <style>

        /* Center the image in the td */
        td img{
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        /* Style the left column like the first row */
        table.matrix tr td:first-child,
        table.matrix th,
        .fake_header {
            font-size: 130%;
            font-weight: bold;
            background-color: #CBDBFF;
        }

        .white {
            background-color: white !important;
        }

        /*
        table.matrix {
            overflow-x: auto;
            border-collapse: collapse;
        }

        td:not(:first-child) {
            border: 2px solid white;
        }*/

        /* Allow displaying text in multiple columns */
        .flex {
          display: flex;                  /* establish flex container */
          flex-direction: row;            /* default value; can be omitted */
          flex-wrap: nowrap;              /* default value; can be omitted */
          justify-content: space-between; /* switched from default (flex-start, see below) */
        }

        </style>
    {% endblock %}

    {% block links %}

    {% if  sim_dirs|length > 1 %}
    <h3>Simulations:</h3>
    <p><a class="fake_button" href="/entry/{{ entry_id }}">Simulation overview</a></p>
    {% for sim in sim_dirs -%}
    <p><a class="fake_button" href="/entry/{{ entry_id }}/{{ sim }}">{{ sim.title() }}</a></p>
    {% endfor %}
    {% endif %}

    <h3>Simulation: {{ simulation }}</h3>
    <p><a class="fake_button_sim" href="http://www.bmrb.wisc.edu/metabolomics/mol_summary/show_data.php?id={{ entry_id }}" target="_blank">BMRB entry</a></p>
    <p><a class="fake_button_sim" href="http://alatis.nmrfam.wisc.edu/examples/BMRB/{{ entry_id }}/index.html" target="_blank">ALATIS cross link</a></p>
    <p><a class="fake_button_sim" href="/entry/{{ entry_id }}/{{ simulation }}/zip">Download simulation data</a></p>
    <p><a class="fake_button_sim" href="/entry/{{ entry_id }}/{{ simulation }}/spin_simulation.xml" target="_blank">View entry XML</a></p>
    {% endblock %}

    {% block body %}

    <div class="details_box">
        <h1>{{ name }}</h1>
        <h2>Simulation outputs:</h2>

        <table class="alternating left_align">
            <tr>
                <td rowspan="30" class="white"><img alt="{{ InChI }}" title="{{ InChI }}" src="/entry/{{ entry_id }}/{{ simulation }}/{{ path_2D_image }}" style="max-width:400px; max-height:auto;"></td>
                <td class="fake_header">Parameter</td>
                <td class="fake_header">Value</td>
            </tr>
            <tr>
                <td>Field strength</td>
                <td>{{ field_strength }}(MHz)</td>
            </tr>
            <tr>
                <td>RMSD of the fit</td>
                <td>{{ roi_rmsd }}</td>
            </tr>
            {% if solvent -%}
            <tr>
                <td>Solvent</td>
                <td>{{ solvent }}</td>
            </tr>
            {% endif -%}
            {% if buffer -%}
            <tr>
                <td>Buffer</td>
                <td>{{ buffer }}</td>
            </tr>
            {% endif -%}
            {% if cytocide -%}
            <tr>
                <td>Cytocide</td>
                <td>{{ cytocide }}</td>
            </tr>
            {% endif -%}
            {% if reference -%}
            <tr>
                <td>Reference</td>
                <td>{{ reference }}</td>
            </tr>
            {% endif -%}
            {% if temperature -%}
            <tr>
                <td>Temperature</td>
                <td>{{ temperature }}</td>
            </tr>
            {% endif -%}
            {% if ph -%}
            <tr>
                <td>pH</td>
                <td>{{ ph }}</td>
            </tr>
            {% endif -%}
            {% if InChI %}
            <tr><td>InChI</td><td>{{ InChI }}</td></tr>
            {% endif %}
            {% if pka %}
            {% if pka is string %}
            <tr><td>pKa</td><td>{{ pka }}</td>
            {% else %}
            {% for one_pka in pka %}<tr><td>pKa</td><td>{{ one_pka }}</td>
            {% endfor %}
            {% endif %}
            {% endif %}
            {% if note %}
            <tr><td>Notes</td><td>{{ note }}</td></tr>
            {% endif %}
        </table>
    </div>

    <div class="details_box">
        <h2>Spin System Matrix</h2>
        <table class="alternating matrix" style="block">
        {% for item in matrix %}{% set outer_loop = loop -%}
        <tr>{% for subitem in item -%}
            {% if outer_loop.first %}<th>{{ subitem }}</th>{% else %}<td>{% if subitem != 0 %}<strong>{{ subitem }}</strong>{% else %}{{ subitem }}{% endif %}</td>{% endif %}{% endfor %}</tr>
        {% endfor -%}
        </table>
    </div>

    <div class="details_box">
        <h2>Spectra</h2>
        <div>
            <p>Select simulated field strength to view:
            <select id="fieldstrength" onchange="load_spectra()">
                    <option value="default" selected="selected">Default</option>
                {% for sim in simulated_fields -%}
                     <option value="{{sim}}MHz">{{sim}}</option>
                {% endfor %}
            </select>
            </p>

            <div class="tooltip">
                <h3>Help</h3>
                <span class="tooltiptext">To zoom into a region, draw a box around it.<br>
                            Hover over the x/y-axis and use mouse-wheel to zoom in/out.<br>
                            Hover over the x/y-axis hold down left-button to move around the spectra.<br>
                            (De)activate a spectrum by clicking on its legend.<br></span>
            </div>
        </div>
        <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
    </div>

    <script type="text/javascript">
        function my_plot(data1, data2, fs){

            var trace1 = {
                x: data1[0],
                y: data1[1],
                name: 'Simulated ' + fs,
                marker: {
                    color: 'rgb(256, 0, 0)',
                    size: 12
                },
                type: 'lines'
            };
            var trace2 = {
                x: data2[0],
                y: data2[1],
                name: 'Experimental data',
                marker: {
                    color: 'rgb(0, 255, 0)',
                    size: 12
                },
                type: 'lines'
            };

            var data = [trace1, trace2];

            var layout = {
                xaxis: {
                    title: 'PPM',
                    autorange: 'reversed',
                    titlefont: {
                        family: 'Arial, sans-serif',
                        size: 18,
                        color: 'black'
                    }
                },
                yaxis: {
                    fixedrange: false
                }
            };
            Plotly.newPlot('myDiv', data, layout, {scrollZoom: true});
        };

        var getJSON = function(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'json';
            xhr.onload = function() {
              var status = xhr.status;
              if (status === 200) {
                callback(null, xhr.response);
              } else {
                callback(status, xhr.response);
              }
            };
            xhr.send();
        };

        // Default experiment data and initial load
        getJSON("/entry/{{ entry_id }}/{{ simulation }}/experimental.json", function(err, data) {
            if (err !== null) {
                alert('Something went wrong: ' + err);
            } else {
                experiment_data = data;
                load_spectra("default");
            }
        });

        function load_spectra(){

            var field_strength = document.getElementById("fieldstrength").value;

            getJSON("/entry/{{ entry_id }}/{{ simulation }}/sim_" + field_strength + ".json", function(err, data) {
                if (err !== null) {
                    alert('Something went wrong: ' + err);
                } else {
                    my_plot(experiment_data, data, field_strength);
                }
            });
        }

    </script>
    {% endblock %}
